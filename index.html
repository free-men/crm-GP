<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>CRM для записів</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; }
    .container { width: 600px; margin: 50px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    input, select, button { padding: 8px; margin: 5px 0; width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
    th { background: #eee; }
  </style>
</head>
<body>
  <div class="container" id="loginBox">
    <h2>Вхід до CRM</h2>
    <input type="text" id="username" placeholder="Логін">
    <input type="password" id="password" placeholder="Пароль">
    <button onclick="login()">Увійти</button>
    <p id="loginMessage" style="color:red"></p>
  </div>

  <div class="container" id="crmBox" style="display:none;">
    <h2>CRM панель</h2>
    <p id="userInfo"></p>

    <div id="filters" style="display:none;">
      <h3>Фільтри (тільки для адміністратора)</h3>
      <input type="date" id="filterDate">
      <input type="text" id="filterBrand" placeholder="Бренд">
      <input type="text" id="filterManager" placeholder="Менеджер">
      <input type="text" id="filterRegion" placeholder="Регіон">
      <button onclick="loadRecords()">Фільтрувати</button>
    </div>

    <h3>Записи</h3>
    <table id="recordsTable">
      <thead>
        <tr>
          <th>ID</th><th>Дата</th><th>Менеджер</th><th>Клієнт</th><th>Бренд</th><th>Купівля</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="exportTableToExcel()">Експорт у Excel</button>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbx5CAwdi4rjEz4C6vvjITtAq_2nJsZ6qDpzFEmoX7C7KLO5xx_pLjL6vrEwYSj6JuPd/exec";

  let currentUser = null;

  async function login() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    const msg = document.getElementById("loginMessage");
    msg.textContent = "";

    try {
      const res = await fetch(`${API_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
      const data = await res.json();
      if (data.success) {
        currentUser = data.user;
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("crmBox").style.display = "block";
        document.getElementById("userInfo").textContent =
          `Вітаю, ${data.user.username} (роль: ${data.user.role}, регіон: ${data.user.region})`;
        if (data.user.role === "admin") {
          document.getElementById("filters").style.display = "block";
        }
        loadRecords();
      } else {
        msg.textContent = "Невірний логін або пароль";
      }
    } catch (e) {
      msg.textContent = "Помилка підключення";
    }
  }

  async function loadRecords() {
    let url = `${API_URL}?action=records&username=${encodeURIComponent(currentUser.username)}&role=${currentUser.role}`;
    if (currentUser.role === "admin") {
      const d = document.getElementById("filterDate").value;
      const b = document.getElementById("filterBrand").value.trim();
      const m = document.getElementById("filterManager").value.trim();
      const r = document.getElementById("filterRegion").value.trim();
      if (d) url += `&date=${d}`;
      if (b) url += `&brand=${b}`;
      if (m) url += `&manager=${m}`;
      if (r) url += `&region=${r}`;
    }
    const res = await fetch(url);
    const records = await res.json();

    const tbody = document.querySelector("#recordsTable tbody");
    tbody.innerHTML = "";
    records.forEach(rec => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${rec.id}</td><td>${rec.date}</td><td>${rec.manager}</td><td>${rec.clientName}</td><td>${rec.brand}</td><td>${rec.purchase ? "✅" : "❌"}</td>`;
      tbody.appendChild(tr);
    });
  }

  function exportTableToExcel() {
    let table = document.getElementById("recordsTable");
    let html = table.outerHTML;
    let url = 'data:application/vnd.ms-excel,' + escape(html);
    let a = document.createElement("a");
    a.href = url;
    a.download = "records.xls";
    a.click();
  }
</script>
</body>
</html>
